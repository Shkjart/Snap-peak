// index.js
require('dotenv').config();
const fs = require('fs');
const path = require('path');
const { Client, GatewayIntentBits, Partials, EmbedBuilder } = require('discord.js');

const TOKEN = process.env.BOT_TOKEN;
const CHANNEL_ID = process.env.CHANNEL_ID || '1431646537045381170';
const DATA_FILE = path.join(__dirname, 'reports.json');
const SEND_INTERVAL_MS = parseInt(process.env.SEND_INTERVAL_MS || '6000', 10);
const MIN_THRESHOLD_MILLIONS = parseFloat(process.env.MIN_THRESHOLD_MILLIONS || '2.5');

if (!TOKEN) {
  console.error('Ø¶Ø¹ BOT_TOKEN ÙÙŠ Ù…Ù„Ù .env');
  process.exit(1);
}
if (!fs.existsSync(DATA_FILE)) {
  fs.writeFileSync(DATA_FILE, JSON.stringify([], null, 2));
  console.log('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ reports.json ÙØ§Ø±Øº. Ø¹Ø¯Ù‘Ù„Ù‡ ÙˆØ£Ø¶Ù ØªÙ‚Ø§Ø±ÙŠØ±Ùƒ.');
}

function readReports() {
  try {
    return JSON.parse(fs.readFileSync(DATA_FILE, 'utf8'));
  } catch (e) {
    console.error('Ø®Ø·Ø£ Ø¨Ù‚Ø±Ø§Ø¡Ø© reports.json:', e);
    return [];
  }
}

function parsePerSecondToMillions(s) {
  if (!s || typeof s !== 'string') return 0;
  let str = s.toLowerCase().replace('/s', '').replace('per second', '').trim();
  str = str.replace(/\$/g, '').trim();
  const m = str.match(/^([\d.,]+)\s*([kmbt]?)/i);
  if (!m) return 0;
  let num = parseFloat(m[1].replace(',', '.'));
  if (isNaN(num)) return 0;
  const suf = (m[2] || '').toLowerCase();
  if (suf === 'k') return num / 1000;
  if (suf === 'm' || suf === '') return num;
  if (suf === 'b') return num * 1000;
  if (suf === 't') return num * 1000000;
  return num;
}

function makeEmbedFromReport(r, serverLinkResolved) {
  const title = `ðŸ”Ž Ø³Ø± Ø¹Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø© ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡ â€” ${r.itemNameAr || r.itemName || 'Unknown'}`;
  const desc = `Ù‡Ù„ ØªØ¨ÙŠ ÙˆØµÙˆÙ„ Ù„Ø£Ø³Ø±Ø§Ø± Ù‚ÙŠÙ…ØªÙ‡Ø§ 10M+ØŸ\nÙ…Ø«Ø§Ù„ Ù…Ù† ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¬ØªÙ…Ø¹.`;
  const perSec = r.perSecond || 'N/A';
  const total = r.totalWorth || 'N/A';
  const player = r.player || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  const serverLink = serverLinkResolved || r.serverLink || (r.serverName || 'ØºÙŠØ± Ù…ØªÙˆÙØ±');

  const embed = new EmbedBuilder()
    .setTitle(title)
    .setDescription(desc)
    .addFields(
      { name: 'Ø§Ù„Ù„Ø§Ø¹Ø¨', value: `${player}`, inline: true },
      { name: 'Ø§Ù„Ù‚ÙŠÙ…Ø©/Ø«Ø§Ù†ÙŠØ©', value: `${perSec}`, inline: true },
      { name: 'Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒÙ„ÙŠØ©', value: `${total}`, inline: true },
      { name: 'Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙŠØ±ÙØ±', value: serverLink, inline: false },
      { name: 'Ø§Ù„Ø§Ø³Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)', value: `${r.itemName || 'N/A'}`, inline: false }
    )
    .setFooter({ text: 'snap peak â€¢ ØªÙ„Ù‚Ø§Ø¦ÙŠ' })
    .setTimestamp()
    .setColor(0xFF4B4B);

  if (r.thumbnail) embed.setThumbnail(r.thumbnail);
  return embed;
}

const client = new Client({
  intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMessages],
  partials: [Partials.Channel],
});

async function resolveServerLink(report) {
  if (report.serverLink && typeof report.serverLink === 'string' && report.serverLink.trim() !== '') {
    return report.serverLink;
  }
  if (report.inviteChannelId) {
    try {
      const ch = await client.channels.fetch(report.inviteChannelId);
      if (ch && typeof ch.createInvite === 'function') {
        const inv = await ch.createInvite({ maxAge: 0, maxUses: 0, unique: false, reason: 'Generated by Snap Peak bot' });
        return `https://discord.gg/${inv.code}`;
      } else {
        return 'Ø§Ù„Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¯Ø¹ÙˆØ©';
      }
    } catch (err) {
      return 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯Ø¹ÙˆØ© (ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª)';
    }
  }
  return 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
}

client.once('ready', () => {
  console.log(`Ø§Ù„Ø¨ÙˆØª Ø¬Ø§Ù‡Ø²: ${client.user.tag}`);
  startAutoSendLoop();
});

async function sendRandomStrongReport() {
  const reports = readReports();
  if (!Array.isArray(reports) || reports.length === 0) {
    console.log('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± ÙÙŠ reports.json');
    return;
  }
  const strong = reports.filter(r => parsePerSecondToMillions(r.perSecond) >= MIN_THRESHOLD_MILLIONS);
  if (strong.length === 0) {
    console.log(`Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ù‚ÙŠÙ…Ø©/Ø«Ø§Ù†ÙŠØ© >= ${MIN_THRESHOLD_MILLIONS}M`);
    return;
  }
  const pick = strong[Math.floor(Math.random() * strong.length)];
  const channel = await client.channels.fetch(CHANNEL_ID).catch(() => null);
  if (!channel || !channel.isTextBased?.()) {
    console.error('Ù…Ø§ Ù‚Ø¯Ø±Øª Ø£Ø¬ÙŠØ¨ Ø§Ù„Ù‚Ù†Ø§Ø©. ØªØ£ÙƒØ¯ Ù…Ù† CHANNEL_ID ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª.');
    return;
  }
  const serverLinkResolved = await resolveServerLink(pick);
  const embed = makeEmbedFromReport(pick, serverLinkResolved);
  try {
    await channel.send({ embeds: [embed] });
    console.log(`Ø£Ø±Ø³Ù„Øª: ${pick.itemName || pick.itemNameAr} (${pick.perSecond}) => ${serverLinkResolved}`);
  } catch (e) {
    console.error('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', e);
  }
}

let autoIntervalHandle = null;
function startAutoSendLoop() {
  if (autoIntervalHandle) clearInterval(autoIntervalHandle);
  sendRandomStrongReport();
  autoIntervalHandle = setInterval(sendRandomStrongReport, SEND_INTERVAL_MS);
}

client.login(TOKEN).catch(err => {
  console.error('Ø®Ø·Ø£ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¨ÙˆØª:', err);
});
